#!/bin/bash

# locals
ENV="staging"
NAME="ponyfoo-$ENV"
KEYFILE="deploy/keys/$ENV"

# instance-specific
INSTANCE_USER=$(cat $KEYFILE.user)
PUBLIC_DNS=$(cat $KEYFILE.dns)

APP="~/apps/$ENV"
APP_CONFIG="$APP/config/"

# upload modifications
rsync \
  -az \
  --stats \
  --delete \
  -e "ssh -i $KEYFILE -o StrictHostKeyChecking=no" \
  .env \
  $INSTANCE_USER@$PUBLIC_DNS:$APP_CONFIG

# jump into instance
ssh -Ti $KEYFILE -o ConnectTimeout=10 -o StrictHostKeyChecking=no $INSTANCE_USER@$PUBLIC_DNS << EOF_RELOAD
  pm2_reload_if_needed () {
    if [ "$(pm2 jlist)" != "[]" ] ; then
      pm2 reload $NAME
    fi
  }

  pm2_reload_if_needed
EOF_RELOAD

echo "Deployed configuration to $ENV"
