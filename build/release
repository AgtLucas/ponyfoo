#!/bin/bash

: ${PORT:="3000"}

npm run clean
npm run copy
npm prune
npm dedupe

DIST=".bin/public"
DOMAIN="http://ponyfoo.com"

# compile
mkdir -p .bin/temp
spritesmith
stylus client/css/all.styl -o $DIST/css --include-css --include client/css --compress
cleancss $DIST/css/all.css -o $DIST/css/all.css --s0
jadum views/**/*.jade -o .bin --no-debug --obj '{"basedir":"views"}'
taunus -o
browserify client/js/main.js --basedir client/js | uglifyjs > $DIST/js/all.js

# critical css inlining. many slash, very escape. PLEASE. STAHP.
LOGGING_LEVEL=info node app &
APP_PID=$(procfinder --wait --port $PORT)
CRITICAL="$(phantomjs node_modules/penthouse/penthouse.js http://localhost:$PORT .bin/public/css/all.css)"
CRITICAL_ESCAPED=$(echo $CRITICAL | sed -e 's/[\/#&]/\\&/g' -e 's/"/\\\\"/g')
LAYOUT=".bin/views/server/layout/layout.js"
echo "Gathered critical CSS, killing node app ($APP_PID)"
kill $APP_PID
sed -i -e "s#<style></style>#<style>$CRITICAL_ESCAPED</style>#" $LAYOUT

reaver $DIST/img/* --manifest | scourge .bin/{views,public/{css,js}} --base-path $DIST --domain $DOMAIN
reaver $DIST/{css,js}/* --manifest | scourge .bin/views/server --base-path $DIST --domain $DOMAIN
